// =========================================================================
// TANK Model 1 - Two-Agent New Keynesian Model without Capital
// 2つの家計タイプ: Saver (リカード型) と Hand-to-Mouth (流動性制約)
// =========================================================================

// マクロスイッチ: CRRA=1 で CRRA 効用、KPR=1 で King-Plosser-Rebelo 型
@#define CRRA = 0
@#define KPR  = 0
@#if FLAG==1
    var D W N MC MU_S C C_H C_S Y R_N R PI m a c n d w;
@#else
    var D W N N_H N_S MC MU_S C C_H C_S Y R_N R PI m a c n d w;
@#endif

varexo eps_a eps_m;

parameters P_beta P_gamma_0 P_gamma P_varphi P_xi P_phi
           P_psi P_eta P_tau_s P_tau_d P_lambda P_alpha P_rho_a P_rho_m;

// -------------------------------------------------------------------------
// 家計パラメータ
// -------------------------------------------------------------------------
P_beta    = 0.95;       // 割引因子 (Saver)
P_gamma_0 = 1.0;        // 労働の不効用レベル項
P_gamma   = 2.0;        // 消費の曲率
P_varphi  = 1.0;        // 労働の曲率
P_xi      = 0.5;        // フリッシュ弾力性の逆数
@#if CRRA==1
    P_xi = 0;           // CRRA モードで労働分離型に
@#endif
@#if KPR==1
    P_gamma = 1.0;      // KPR スイッチで消費曲率を1に
@#endif

P_alpha   = 0.3;       // 生産における労働シェア (資本なしケース)
P_eta     = 1.0;        // 価格調整コストのスケール
P_psi     = 5.0;        // マークアップ弾力性 (カルボ型)
P_lambda  = 0.25;       // Hand-to-Mouth 家計のシェア
P_tau_s = 1/(1-1/P_psi)-1; // 定常状態補助金ゼロの売上税率
//P_tau_s   = 0.0;        // 売上税率
P_tau_d   = 0.0;        // 配当税率

// -------------------------------------------------------------------------
// 政策パラメータ
// -------------------------------------------------------------------------
P_phi = 1.5;            // テイラー・ルールのインフレ係数

// -------------------------------------------------------------------------
// ショック持続性
// -------------------------------------------------------------------------
P_rho_a = 0.9;          // 選好ショック持続性
P_rho_m = 0.8;          // 金融政策ショック持続性

// =========================================================================
model;
// =========================================================================

// -------------------------------------------------------------------------
// Hand-to-Mouth 家計 (H): 予算制約・労働供給条件
// -------------------------------------------------------------------------
@#if FLAG==1
    C_H = W * N + (P_tau_d / P_lambda) * D;
    W = C^P_gamma * N^P_varphi;
@#else
    C_H = W * N_H + (P_tau_d / P_lambda) * D;
    W = C_H^P_gamma * N_H^P_varphi;
    W = C_S^P_gamma * N_S^P_varphi;
    N = P_lambda * N_H + (1 - P_lambda) * N_S;
@#endif

// -------------------------------------------------------------------------
// Saver 家計 (S): 限界効用・オイラー方程式
// -------------------------------------------------------------------------
// 限界効用（CRRAまたはGHH/KPRで切替）
@#if CRRA==1
    MU_S = C_S^(-P_gamma);
@#else
    @#if FLAG==1
        @#if KPR==1
            // King-Plosser-Rebelo 型: GHH 近似
            MU_S = C_S^(-P_xi-1) * exp(P_gamma_0 * P_xi * N^(1+P_varphi) / (1+P_varphi));
        @#else
            // GHH 型 (Greenwood-Hercowitz-Huffman)
            MU_S = - C_S^(-P_gamma) * (
                - C_S^(1-P_gamma) / (1-P_gamma)
                + P_gamma_0 * N^(1+P_varphi) / (1+P_varphi)
            )^(-P_xi/(1-P_gamma));
        @#endif
    @#else
        @#if KPR==1
            // King-Plosser-Rebelo 型: GHH 近似
            MU_S = C_S^(-P_xi-1) * exp(P_gamma_0 * P_xi * N_S^(1+P_varphi) / (1+P_varphi));
        @#else
            // GHH 型 (Greenwood-Hercowitz-Huffman)
            MU_S = - C_S^(-P_gamma) * (
                - C_S^(1-P_gamma) / (1-P_gamma)
                + P_gamma_0 * N_S^(1+P_varphi) / (1+P_varphi)
            )^(-P_xi/(1-P_gamma));
        @#endif
    @#endif
@#endif

// オイラー方程式
1 = P_beta * (MU_S(+1) / MU_S) * R_N / PI(+1);

// -------------------------------------------------------------------------
// 企業 (Firms)
// -------------------------------------------------------------------------
// 限界費用
W = (1 - P_alpha) * MC * exp(a) * N^(-P_alpha);
// 配当（価格調整コスト込み）
D = Y - 0.5 * P_eta * (PI - 1)^2 * Y - W * N;
// ニューケインジアン・フィリップス曲線
P_eta * (PI - 1) * PI = P_psi * (MC - (1 + P_tau_s) * (1 - 1/P_psi))
    + P_beta * P_eta * (MU_S(+1) / MU_S) * (Y(+1) / Y) * (PI(+1) - 1) * PI(+1);

// -------------------------------------------------------------------------
// 金融政策（テイラー・ルール）
// -------------------------------------------------------------------------
R_N = exp(-m) * (1 / P_beta) * (PI^P_phi);
R = R_N / PI(+1);

// -------------------------------------------------------------------------
// 集計・市場均衡
// -------------------------------------------------------------------------
C = P_lambda * C_H + (1 - P_lambda) * C_S;
Y = exp(a) * N^(1 - P_alpha);
Y = C;

// -------------------------------------------------------------------------
// ショック過程
// -------------------------------------------------------------------------
a = P_rho_a * a(-1) + eps_a;
m = P_rho_m * m(-1) + eps_m;

// -------------------------------------------------------------------------
// 補助変数: 定常状態からの対数偏差
// -------------------------------------------------------------------------
c = log(C / steady_state(C));
n = log(N / steady_state(N));
w = log(W / steady_state(W));
d = (D - steady_state(D)) / steady_state(Y);

end;

// =========================================================================
// 初期値
// =========================================================================
initval;
D   = 0;
W   = 1;
N   = 1;
@#if FLAG==0
    N_H = 1;
    N_S = 1;
@#endif
C   = 1;
C_H = 1;
C_S = 1;
MC  = (1 + P_tau_s) * (1 - 1/P_psi);
MU_S = 1;
Y   = 1;
R_N = 1;
R   = 1;
PI  = 1;
m   = 0;
a   = 0;
end;

// =========================================================================
// ショック
// =========================================================================
shocks;
var eps_a = 0.01;   // 選好ショック分散
var eps_m = 0.01;   // 金融政策ショック分散
end;

// =========================================================================
// 計算
// =========================================================================
steady;
check;

// パラメータと定常状態をテキストファイルに保存
save_params_and_steady_state('TANKC_model1_steady.txt');

stoch_simul(order=1, irf=20, nograph) c n d w;