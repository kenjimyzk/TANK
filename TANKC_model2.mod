// =========================================================================
// TANK Model 2 - TANKC_model1 の定常状態まわりの線形化モデル
//
// 使い方:
// 1. まず TANKC_model1.mod を実行し TANKC_model1_steady.txt を生成
// 2. 続けて本ファイルを実行
// =========================================================================

// -------------------------------------------------------------------------
// 変数とショック
// -------------------------------------------------------------------------
@#if FLAG==1
    var d w n mc mu_S c c_H c_S y r_N r pi m a;
@#else
    var d w n n_H n_S mc mu_S c c_H c_S y r_N r pi m a;
@#endif

varexo eps_a eps_m;

// -------------------------------------------------------------------------
// パラメータ
// -------------------------------------------------------------------------
parameters P_beta P_gamma_0 P_gamma P_varphi P_xi P_kappa P_phi
           P_psi P_eta P_tau_s P_tau_d P_lambda P_alpha P_rho_a P_rho_m;

// 定常状態をパラメータとして保持（TANKC_model1 から読込）
@#if FLAG==1
    parameters W N MC C C_H C_S Y D;
@#else
    parameters W N N_H N_S MC C C_H C_S Y D;
@#endif

load_params_and_steady_state('TANKC_model1_steady.txt');

// 均衡での κ: 価格調整コストの線形近似係数
@#if FLAG==1
    P_kappa = P_xi /
        (1 - (1 - P_alpha) * MC * (1 - P_gamma) / (1 + P_varphi) * (C / C_S));
@#else
    P_kappa = P_xi /
        (1 - (1 - P_alpha) * MC * (1 - P_gamma) / (1 + P_varphi) * ((N_S / N) / (C_S / C)));
@#endif

// =========================================================================
model(linear);
// =========================================================================

// -------------------------------------------------------------------------
// Hand-to-Mouth 家計 (H)
// -------------------------------------------------------------------------
// 労働供給条件
@#if FLAG==1
    w = P_gamma * c + P_varphi * n;
@#else
    w = P_gamma * c_H + P_varphi * n_H;
    w = P_gamma * c_S + P_varphi * n_S;
    n = P_lambda * (N_H / N) * n_H + (1 - P_lambda) * (N_S / N) * n_S;
@#endif

// 予算制約（賃金所得＋配当の取り分）
@#if FLAG==1
    (C_H / C) * c_H = (1 - P_alpha) * MC * (w + n) + (P_tau_d / P_lambda) * d;
@#else
    (C_H / C) * c_H = (1 - P_alpha) * MC * (N_H / N) * (w + n_H) + (P_tau_d / P_lambda) * d;
@#endif

// -------------------------------------------------------------------------
// Saver 家計 (S)
// -------------------------------------------------------------------------
// オイラー方程式
r_N = pi(+1) + mu_S - mu_S(+1);

// 限界効用
@#if FLAG==1
    mu_S = - (P_gamma + P_kappa) * c_S
        + P_kappa * (1 - P_alpha) * MC * (C / C_S) * n;
@#else
    mu_S = - (P_gamma + P_kappa) * c_S
        + P_kappa * (1 - P_alpha) * MC * ((N_S / N) / (C_S / C)) * n_S;
@#endif

// -------------------------------------------------------------------------
// 企業
// -------------------------------------------------------------------------
// 限界費用: W = (1-α) MC exp(a) N^(-α) を線形化 → w = mc + a - α·n
w = mc + y - n;

// 利潤配当: D = Y - W·N を線形化
d = (1 - MC) * y + (P_alpha - 1) * MC * w;

// ニューケインジアン・フィリップス曲線
pi = P_beta * pi(+1) + P_psi * (MC / P_eta) * mc;

// -------------------------------------------------------------------------
// 金融政策（テイラー・ルール）
// -------------------------------------------------------------------------
r_N = P_phi * pi - m;
r = r_N - pi(+1);

// -------------------------------------------------------------------------
// 集計・市場均衡
// -------------------------------------------------------------------------
c = P_lambda * (C_H / C) * c_H + (1 - P_lambda) * (C_S / C) * c_S;
y = a + (1 - P_alpha) * n;   // 線形化された生産関数
y = c;                        // 財市場均衡

// -------------------------------------------------------------------------
// ショック過程
// -------------------------------------------------------------------------
a = P_rho_a * a(-1) + eps_a;
m = P_rho_m * m(-1) + eps_m;

end;

// =========================================================================
// ショック
// =========================================================================
shocks;
var eps_a = 0.01;   // TFP ショック分散
var eps_m = 0.01;   // 金融政策ショック分散
end;

steady;
check;

stoch_simul(order=1, irf=20, nograph) c n d w;